function ctrl_variables($scope,$route,$timeout,conexion,catalogos,$rootScope){
	$scope.valExp="";$scope.variable={};$scope.exp_var=function(dsnombre,id){var variable={};variable.idvariable=id;variable.dsnombre=dsnombre;$rootScope.variable_exp=variable;force_redirect("index_adm.html#/catalogo_variables_exp")};if($rootScope.variable_exp){$scope.variable=$rootScope.variable_exp;$scope.expresion={};$scope.expresion.dsexpresion="";$scope.expresion.idvariable=$scope.variable.idvariable;$("#prevExp").caret(-1);delete $rootScope.variable_exp;$timeout(function(){$scope.obtener_exp();},1000);}
$scope.put_var=function(txt_var,tipo){var tipovar="";var cierre="} ";var txt=$scope.expresion.dsexpresion;var pos=$("#prevExp").caret();var txtput="";switch(tipo){case('v'):tipovar="${var: ";break;case('f'):tipovar="${cmp: ";break;case('g'):tipovar="${gpo: ";break;case('n'):tipovar="f: ";cierre=" ";break;default:cierre=" ";}
txtput=tipovar+txt_var+cierre;$scope.expresion.dsexpresion=insertStringAt(txt,pos,txtput);$timeout(function(){$("#prevExp").caret(pos+txtput.length);},500);}
$scope.refreshListVars=function(){catalogos.get_lista_variables($scope);}
$scope.refreshListGpo=function(){catalogos.get_lista_grupos($scope);}
$scope.refreshListFns=function(){catalogos.get_lista_funciones($scope);}
$scope.agregaVariable=function(){$scope.variable.tipoVariable=$scope.variable.tipoDato.dscodigo
conexion.var_agregar({"usuario":$rootScope.usr_global,"variable":$scope.variable},function(data){if(data.exito){ejecutaAlerta(1,'Se guardó correctamente la variable '+data.estatus);$scope.refreshListVars();}else{ejecutaAlerta(2,'Ocurrió un error: '+data.estatus);}},function(error){ejecutaAlerta(2,'Ocurrió un error al guardar la variable: '+error.status);});}
$scope.sel_edit_var=function(variable){$scope.variable=variable;$("#tipo_dato option").each(function(element,index){if($(this).text()==variable.tipoDato.dselemento){$scope.variable.tipoDato=$scope.tipo_dato[$(this).val()];}});$scope.iseditvar=true;}
$scope.edit_var=function(){conexion.var_edit({"usuario":$rootScope.usr_global,"variable":$scope.variable},function(data){if(data.exito){ejecutaAlerta(1,'Se actualizó correctamente la variable ');$scope.refreshListVars();}else{ejecutaAlerta(2,'Ocurrió un error: '+data.estatus);}},function(error){ejecutaAlerta(2,'Algo malo paso al actualizar la variable: '+error.status);});}
var muestro_p_a_e=true;$scope.mostrar_ayuda_expresion=function(){var txtBtn=(muestro_p_a_e)?"<span>+</span>Abrir panel de ayuda":"<span>+</span>Cerrar ayuda";$("#ayudaExpresion").html(txtBtn);$("#p_a_e").slideToggle("slow");muestro_p_a_e=(muestro_p_a_e)?false:true;$("#val_exp_input").prop("disabled",muestro_p_a_e);}
$scope.valida_exp=function(){var mensajetiempo=0;var tiempoIncremento=1500;conexion.exp_validar({"usuario":$scope.usr_global,"expresion":{"dsexpresion":$scope.expresion.dsexpresion,"variable":{}}},function(data){if(data.exito){ejecutaAlerta(1,"La expresión tiene una sintaxis correcta");}else{for(var i=0;i<data.errores.length;i++){var mensaje="Error:"+data.errores[i].mensaje;$timeout(function(){ejecutaAlerta(2,mensaje);},mensajetiempo);mensajetiempo+=tiempoIncremento;}}},function(error){alert("Algo malo paso al intentar validar la expresion: "+error.status);});}
$scope.guarda_exp=function(){conexion.exp_guardar({"usuario":$scope.usr_global,"expresion":{"dsexpresion":$scope.expresion.dsexpresion,"idvariable":$scope.variable.idvariable,"variable":{}}},function(data){if(data.exito){ejecutaAlerta(1,"Se guardó correctamente la expresión");$timeout(function(){force_redirect("index_adm.html#/catalogo_variables");},1000);}else{ejecutaAlerta(2,"Ocurrió un error:"+data.estatus);}},function(error){alert("Algo malo paso al asignar la expresión a la variable:"+error.status);});}
$scope.actualiza_exp=function(){conexion.exp_actualizar({"usuario":$scope.usr_global,"expresion":$scope.expresion},function(data){if(data.exito){ejecutaAlerta(1,"Se actualizó correctamente la expresión");$timeout(function(){force_redirect("index_adm.html#/catalogo_variables");},1000);}else{ejecutaAlerta(2,"Ocurrió un error:"+data.estatus);}},function(error){alert("Algo malo paso al actualizar la expresión a la variable: "+error.status);});}
$scope.obtener_exp=function(){conexion.exp_listar_x_var({"usuario":$scope.usr_global,"expresion":{"idvariable":$scope.variable.idvariable}},function(data){if(data.exito){if(data.expresionList&&data.expresionList.length>0){$scope.actualiza_exp_f=true;$scope.expresion=data.expresionList[data.expresionList.length-1];}else{$scope.expresion.dsexpresion="";}}else{ejecutaAlerta(2,"Ocurrió un error: "+data.estatus);}},function(error){alert("Algo malo paso al obtener la expresión a la variable: "+error.status);});}
catalogos.get_tipo_dato($scope,function(){$scope.variable.tipoDato=$scope.tipo_dato[0];});catalogos.get_operadores($scope);$scope.refreshListVars();$scope.refreshListGpo();$scope.refreshListFns();
}